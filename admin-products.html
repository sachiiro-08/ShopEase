<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Products - ShopEase</title>
  <link rel="stylesheet" href="css/admin.css">
</head>
<body>
<header class="admin-header">
    <div class="brand">ShopEase Admin</div>
    <nav class="admin-nav">
        <a href="admin-dashboard.html">Dashboard</a>
        <a href="admin-products.html" class="active">Products</a>
        <a href="admin-orders.html">Orders</a>
        <a href="admin-users.html">Users</a>
        <a href="admin-userfeedback.html">User Feedback</a>
        <a href="../login.html">Logout</a>
    </nav>
</header>

<main class="admin-product-page container">
    <h1>Manage Products</h1>

    <div id="search-container">
        <input type="text" id="search-input" placeholder="Search by name, category, or description...">
        <button class="btn btn-search" onclick="fetchProducts()">Search</button>
    </div>
    <form id="product-form" action="/admin/products" method="POST">
        <input type="hidden" id="product-id" />
        <input type="text" id="product-name" placeholder="Product Name" required />
        <input type="number" id="product-price" placeholder="Price" required />
        <input type="number" id="product-stock" placeholder="Stock" required />
        <input type="text" id="product-description" placeholder="Description" />
        <input list="categoryOptions" name="category" placeholder="Category">
        <datalist id="categoryOptions">
            <option value="Clothing">Clothing</option>
            <option value="Food">Food</option>
            <option value="Books">Books</option>
            <option value="Stationery">Stationery</option>
        </datalist>
        <input type="file" id="product-image" name="image" accept="image/*" />
        <button type="submit" class="btn primary">Add Product</button>
    </form>

    <div id="product-list" class="grid grid-3"></div>
</main>

<script>
    const token = localStorage.getItem("authToken");
    const role = localStorage.getItem("authRole");

    if (!token || role !== "admin") {
        alert("Unauthorized access.");
        window.location.href = "login.html";
    }

    // Utility function to reset the form state
    function resetForm() {
        const form = document.getElementById('product-form');
        form.reset();
        document.getElementById('product-id').value = '';
        document.querySelector('.btn.primary').textContent = 'Add Product';
    }

    // Fetch and display products
    async function fetchProducts() {
        const searchInput = document.getElementById('search-input').value;

        let url = '/api/products';
        if (searchInput) {
            const params = new URLSearchParams({ search: searchInput });
            url = `/api/products?${params.toString()}`;
        }
        

        const container = document.getElementById('product-list');
        container.innerHTML = '<div>Loading products...</div>';

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Failed to fetch products');
            
            const products = await res.json();
            container.innerHTML = '';

            if (products.length === 0) {
                container.innerHTML = `<div style="padding:20px; text-align:center; color:#555;">No products found for "${searchInput}".</div>`;
                return;
            }

            products.forEach(product => {
                const productData = {
                    _id: product._id,
                    name: product.name,
                    price: product.price,
                    stock: product.stock,
                    description: product.description || '',
                    category: product.category || ''
                };
                const safeProductDataString = JSON.stringify(productData).replace(/"/g, '&quot;');
                // --- END SECURITY IMPROVEMENT ---

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${product.name}</h3>
                    <p>Price: â‚±${product.price.toLocaleString('en-PH')}</p>
                    <p>Stock: ${product.stock}</p>
                    <p class="description">Description: ${product.description || ''}</p>
                    <p>Category: ${product.category || ''}</p>
                    <div class="thumb">
                        ${product.image ? `<img class="product-img" src="${product.image}" alt="${product.name}">` : ''}
                    </div>
                    <div class="card-buttons">
                        <button class="btn edit" onclick="editProduct('${safeProductDataString}')">Edit</button>
                        <button class="btn delete" onclick="deleteProduct('${product._id}')">Delete</button>
                    </div>
                `;

                container.appendChild(card);
            });
        } catch (err) {
            console.error('Error fetching products:', err);
            container.innerHTML = '<div style="color:red; padding:20px;">Failed to load products. Check the server.</div>';
        }
    }

    fetchProducts();

    // Search on Enter
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            fetchProducts();
        }
    });

    // Add / Edit product
    const form = document.getElementById('product-form');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = document.getElementById('product-id').value;
        const formData = new FormData();
        formData.append('name', document.getElementById('product-name').value);
        formData.append('price', parseFloat(document.getElementById('product-price').value));
        formData.append('stock', parseInt(document.getElementById('product-stock').value));
        formData.append('description', document.getElementById('product-description').value);
        formData.append('category', document.querySelector('input[name="category"]').value);

        const fileInput = document.getElementById('product-image');
        if (fileInput.files[0]) formData.append('image', fileInput.files[0]);

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/products/${id}` : '/api/products';

        try {
            const res = await fetch(url, { method, body: formData });
            if (!res.ok) throw new Error('Server error when saving product.');
            
            resetForm(); // Use the new reset function
            fetchProducts();
        } catch (err) {
            console.error('Error saving product:', err);
            alert('Failed to save product. Check console for details.');
        }
    });

    // Edit product
    window.editProduct = function(safeProductDataString) {
        // Parse the safely encoded string back into a JavaScript object
        const product = JSON.parse(safeProductDataString.replace(/&quot;/g, '"'));

        document.getElementById('product-id').value = product._id;
        document.getElementById('product-name').value = product.name;
        document.getElementById('product-price').value = product.price;
        document.getElementById('product-stock').value = product.stock;
        document.getElementById('product-description').value = product.description;
        document.querySelector('input[name="category"]').value = product.category;

        document.querySelector('.btn.primary').textContent = 'Update Product';

        document.getElementById('product-image').value = '';
        
        document.getElementById('product-form').scrollIntoView({ behavior: 'smooth' });
    };
    // --- END SECURITY IMPROVEMENT ---

    // Delete product
    window.deleteProduct = async function(id) {
        if (!confirm('Are you sure you want to delete this product?')) return;

        try {
            await fetch(`/api/products/${id}`, { method: 'DELETE' });
            fetchProducts();
        } catch (err) {
            console.error('Error deleting product:', err);
            alert('Failed to delete product.');
        }
    };
</script>
</body>
</html>
