<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin-Orders - ShopEase</title>
  <link rel="stylesheet" href="css/admin.css">
</head>
<body>
  <header class="admin-header">
    <div class="brand">ShopEase Admin</div>
    <nav class="admin-nav">
      <a href="admin-dashboard.html">Dashboard</a>
      <a href="admin-products.html">Products</a>
      <a href="admin-orders.html" class="active">Orders</a>
      <a href="admin-users.html">Users</a>
      <a href="admin-userfeedback.html">User Feedback</a>
      <a href="../login.html">Logout</a>
    </nav>
  </header>

  <main class="admin-orders">
    <h1>Manage Orders</h1>
    <div id="order-list" class="grid grid-3"></div>
  </main>
  
<script>
    //safely format the address
    function formatAddress(address) {
        if (!address || !address.street) return '— No Address Saved —';
        return `${address.street}, ${address.municipality}, ${address.province}`;
    }
    
    async function loadOrders() {
      const res = await fetch('/admin/api/orders');
      const orders = await res.json();
      const container = document.getElementById('order-list');
      container.innerHTML = '';

      orders.forEach(order => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="order-summary"> 
              <h3 class="order-id">Order ID: ${order._id}</h3>
            </div>
          <p class="ordercus"><strong>Customer:</strong> ${order.customerName} (${order.email})</p>
        
          <div class="delivery-info">
              <p style="margin: 0;"><strong>Delivery Address:</strong></p>
              <p style="margin: 0; font-weight: bold; color: #007bff;">
                ${formatAddress(order.shippingAddress)}
              </p>
          </div>
          <p class="orderprod"><strong>Product(s):</strong> ${order.products.map(p => 
            `${p.name || (p.productId && p.productId.name) || 'Unknown'} (x${p.quantity || 1})`
          ).join(', ')}</p>
          <p class="tot"><strong>Total:</strong> ₱${Number(order.totalPrice).toFixed(2)}</p>
          <p class="stat"><strong>Status:</strong>
            <select onchange="updateStatus('${order._id}', this.value)">
              <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
              <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
              <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
              <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
            </select>
          </p>
          <button class="btn delete" onclick="deleteOrder('${order._id}')">Delete Order</button>
        `;
        container.appendChild(card);
      });
    }

    async function updateStatus(id, status) {
      await fetch(`/admin/api/orders/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      loadOrders();
    }

    async function deleteOrder(id) {
      if (!confirm('Are you sure you want to delete this order?')) return;
      await fetch(`/admin/api/orders/${id}`, { method: 'DELETE' });
      loadOrders();
    }

    loadOrders();
</script>

</body>
</html>